<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  </head>
  <body>
    <div class="slider" style="width: 360px;">
      <div class="back">  <canvas id="hue"></canvas> </div>
      <div class="cursor"></div>
    </div>
    <div id="status"></div>
    <video id="video" muted autoplay></video>
    <script>
"use strict";

navigator.getUserMedia = navigator.getUserMedia ||
  navigator.webkitGetUserMedia ||
  navigator.mozGetUserMedia;

const video = document.querySelector("#video");
navigator.getUserMedia({video: true}, (stream) => {
  video.src = setAttribute("src", stream);
},()=>{});

const socket = io();

socket.on('light_status', (data)=>{
  document.querySelector("#status").textContent = JSON.stringify(data);
});

function send_light(data){
  socket.emit('light_data', data);
}

const hue = document.getElementById("hue");
hue.style.width = "360px";
hue.style.height = "20px";
hue.width = 360;
hue.height = 20;

const cx = hue.getContext("2d");
for(let i = 0; i < 360; i++){
  cx.beginPath();
  cx.strokeStyle = `hsl(${i}, 100%, 50%)`;
  cx.lineWidth = 1;
  cx.moveTo(i,0);
  cx.lineTo(i,hue.height);
  cx.stroke();
}

function init_slider(){
  let draged;
  const sliders = document.querySelectorAll(".slider");
  document.addEventListener("mouseup", (e)=>{
    draged = null;
  });
  document.addEventListener("mousemove", (e)=>{
    if(draged){
      draged.dataset.cvalue = e.clientX;
      update_slider();
    }
  });
  sliders.forEach((s)=>{
    s.dataset.cvalue = "0";
    s.addEventListener("mousedown", (e)=>{
      draged = s;
      draged.dataset.cvalue = e.clientX;
      update_slider();
    });
    const c = s.querySelector(".cursor");
    c.style.top = `${16}px`;
  });
  update_slider();
};

init_slider();

function update_slider(){
  const sliders = document.querySelectorAll(".slider");
  sliders.forEach((s)=>{
    const c = s.querySelector(".cursor");
    let l = s.dataset.value = Math.min(365,Math.max(0,+s.dataset.cvalue-22));
    send_light({"hue": l});
    console.log("update",s.dataset.cvalue,l);
    c.style.left = `${5 + 0|s.dataset.value}px`;
  });
};

  </script>
  <style>
body {
  padding: 0px;
  background: #333;
  color: #eee;
}
.cursor {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 4px #ddd solid;
}
.slider {
  padding: 20px;
  position: relative;
}
.back {
  height: 20px;
}
.cursor {
  position: absolute;
}
  </style>
  </body>
</html>
